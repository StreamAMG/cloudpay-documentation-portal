# IAP Integration

CloudPay supports In App Purchases from the following providers:

- Amazon
- Android
- Apple
- Roku

## Setup

### Generic

In order to support IAP a corresponding package must be created in CloudPay that matches the IAP package in terms of cost, type (recurring or non recurring) and contract length.  The product ID/s obtained from the IAP provider is used to link the CloudPay packages, this can be achieved by manually entering the IAP product ID within the CloudPay Admin console for the selected package.  This allows us to sync the various states from the providers such as Renewals, Cancellations, Refunds etc and therefore provide access to premium content.

When an IAP purchase is made, the IAP integrator should verify the receipt with the CloudPay [verify end point](https://streamamg.stoplight.io/docs/cloudpay/reference/CloudPay-API-Specification.yaml/paths/~1iap~1verify/post).  Based on a successful response the user subscription status and entitlement in CloudPay is updated which are used to access premium content.

Status updates and changes are managed via two routes.

- Receipt verification
- Notification service

Further information can be found in the provider specific setup.

### Provider specific

Each provider has their own specific setup and Integration.  

#### Amazon

##### Receipt verification 
Receipt Verification Service (RVS) provides two environment options, depending on whether your app is in the development/testing stage or has been published to the Amazon Appstore:

- **RVS Cloud Sandbox**: While developing and testing your app, use an RVS Sandbox environment to verify receipts generated by the App Tester testing tool. To set up an RVS Cloud Sandbox, see [Use RVS Cloud Sandbox](https://developer.amazon.com/docs/in-app-purchasing/rvs-cloud-sandbox.html)
- **RVS production server**: After you publish your app to the Amazon Appstore, you can use the Amazon RVS production server. See [Instructions for RVS Production Environment](https://developer.amazon.com/docs/in-app-purchasing/iap-rvs-setup-prod.html)

##### Notification service
Amazon provides a notification service which under specific situations will send out a notification of a subscription change, this is not guaranteed and should not be relied on for all subscription updates.

Amazon notifies developers about a user’s purchase state of in-app items via receipts. A receipt contains information about the IAP that developers define at the time of submitting an app along with order state. Currently, to get the latest receipt status, you need to follow a **pull model** by querying Amazon services by calling [Receipt Verification Service (RVS)](https://developer.amazon.com/docs/in-app-purchasing/iap-rvs-for-android-apps.html) periodically.

With Real-Time Notifications, Amazon provides real-time ***server push notifications***. Amazon’s RTN server sends a notification to CloudPay with information about a user's purchase, which can then be verified with RVS.

```https://{client-cloudpay-instance}.streamamg.com/notification/v1/amazon```

##### StreamAMG Requirements

- **Shared secret**: Shared secret used to identify the developer issuing the request. This is added to the CloudPay Admin console and can be found on the Shared Key page for your [developer account with the Amazon Appstore](https://developer.amazon.com/sdk/shared-key.html).

- **CloudPay endpoint**: CloudPay endpoint will be provided as part of the setup.

#### Android

##### Receipt verification 
CloudPay will verify the receipts sent from the App with Google.

##### Notification service
Google offers a guaranteed real-time developer notification (RTDN) service which forwards updates to CloudPay allowing it to react immediately to subscription state changes, avoiding the need to poll the Google Play Developer API.  RTDN leverages the use of [Google Cloud Pub/Sub](https://cloud.google.com/pubsub/docs/overview) which is a fully managed real-time messaging service that you can use to send and receive messages between independent applications. Google Play uses Cloud Pub/Sub to publish push notifications on topics to which you subscribe.  Once setup you should add the CloudPay endpoint which will consume these notifications.

```https://{client-cloudpay-instance}.streamamg.com/notification/v1/android```

##### StreamAMG Requirements:

- **Client Email**: Client Email is used to identify the developer issuing the request.  This is added to the CloudPay Admin console.  An example of this would be; `sa-name` is the name of your service account, and `project-id` is the ID of your Google Cloud project. You can retrieve the `sa-name@project-id.iam.gserviceaccount.com` string from the [Service Accounts](https://console.cloud.google.com/iam-admin/serviceaccounts/) page in the Cloud Console.

- **Service Account Key/Private Key**: Private Key is used to identify the developer issuing the request.  This is added to the CloudPay Admin console.  You can create a [service account key](https://cloud.google.com/iam/reference/rest/v1/projects.serviceAccounts.keys) using the Cloud Console, the `gcloud` tool, the [serviceAccounts.keys.create()](https://cloud.google.com/iam/reference/rest/v1/projects.serviceAccounts.keys/create) method, or one of the [client libraries](https://cloud.google.com/apis/docs/cloud-client-libraries).

- **CloudPay endpoint**: CloudPay endpoint will be provided as part of the setup.


#### Apple

##### Receipt verification 
CloudPay will verify the receipts sent from the App with the Apple verifyReceipt API. The Apps shared secret is required as part of the request.

##### Notification service
Apple provides a notification service which under specific situations will send out a notification of a subscription change, this is not guaranteed and should not be relied on for all subscription updates.  

In order to receive these notifications from the App Store, you must provide a URL in your App Store Connect account that links to your CloudPay server.  Details of how to enable Apple Server Notification can be found [here](https://help.apple.com/app-store-connect/#/dev0067a330b)

```https://{client-cloudpay-instance}.streamamg.com/notification/v1/apple```

Using the App Store server notification service is optional but recommended, especially if you offer subscription services across multiple platforms and you need to keep the subscription records updated.

##### StreamAMG Requirements:

- **App-Specific Shared Secret**: Shared secret is used to identify the developer issuing the request.  This is added to the CloudPay Admin console and can be accessed via the In-App Purchase section on your [App Store Connect](https://appstoreconnect.apple.com/) account.

- **CloudPay endpoint**: Added in the App Store Connect account.  CloudPay endpoint will be provided as part of the setup.


#### Roku

##### Receipt verification 
CloudPay will verify the receipts sent from the App with the Roku Validate-transaction API. The Partner API key is required as part of the request.

##### Notification service
Publishers can subscribe to Roku Pay push notifications by providing the CloudPay endpoint on the [Roku Pay Web Services](https://developer.roku.com/docs/developer-program/roku-pay/quickstart/setting-up-web-services.md#push-notification-url) page in the Developer Dashboard.  However, this is not guaranteed and should not be relied on for all subscription updates.

```https://{client-cloudpay-instance}.streamamg.com/notification/v1/roku```

##### StreamAMG Requirements:
- **Partner API Key**: Private Key is used to identify the developer issuing the request.  This is added via the CloudPay Admin console and can be accessed from the [Roku Pay Web Services](https://developer.roku.com/docs/developer-program/roku-pay/implementation/roku-web-service.md#roku-pay-api-key) page in the Developer Dashboard.

- **CloudPay endpoint**: CloudPay endpoint will be provided as part of the setup.


## Guide

### Amazon

1. Create a ***Subscriptions*** based IAP via the ***Amazon App Store***. Developer details can be found [here.](https://developer.amazon.com/docs/in-app-purchasing/iap-overview.html).
2. Add CloudPay notification end point (supplied by StreamAMG) to the ***Real-Time Notifications*** section in the App Store.
3. Create CloudPay packages via the Admin console that match the IAP packages in terms of cost, type (renewable or non-renewable) and subscription length.
4. Add Providers and Product ID to the corresponding CloudPay packages via the Admin console.
5. Add ***Shared secret*** access token to CloudPay admin console.
6. Forward User IAP receipt info to the CloudPay [verify](https://streamamg.stoplight.io/docs/cloudpay/reference/CloudPay-API-Specification.yaml/paths/~1iap~1verify/post) end point after a user purchase.


### Android

1. Active a ***Merchant account*** in your Google Developer account.
2. Create a ***Subscriptions*** IAP via the ***Google developer account***.  Developer details can be found [here.](https://developer.android.com/google/play/billing/getting-ready)
3. Add CloudPay notification end point (supplied by StreamAMG) to your ***Google Cloud Pub/Sub***.
4. Create CloudPay packages via the Admin console that match the IAP packages in terms of cost, type (renewable or non-renewable) and subscription length.
5. Add Providers and Product ID to the corresponding CloudPay packages via the Admin console.
6. Add ***Client Email & Account Service Key*** to CloudPay admin console.
7. Forward User IAP receipt info to the CloudPay [verify](https://streamamg.stoplight.io/docs/cloudpay/reference/CloudPay-API-Specification.yaml/paths/~1iap~1verify/post) end point after a user purchase.


### Apple

1. Create ***Auto-Renewable Subscription*** IAP via the ***App Store Connect***. Developer details can be found [here](https://developer.apple.com/in-app-purchase/).
2. Add CloudPay notification end point (supplied by StreamAMG) to your ***App Store Connect*** account.
3. Create CloudPay packages via the Admin console that match the IAP packages in terms of cost, type (renewable or non-renewable) and subscription length.
4. Add Providers and Product ID to the corresponding CloudPay packages via the Admin console.
5. Add ***App-Specific Shared Secret*** access token to CloudPay admin console.
6. Forward User IAP receipt info to the CloudPay [verify](https://streamamg.stoplight.io/docs/cloudpay/reference/CloudPay-API-Specification.yaml/paths/~1iap~1verify/post) end point after a user purchase.


### Roku

1. Create a ***Subscription*** based IAP via the ***Roku Developer Account***.  Developer details can be found [here.](https://developer.roku.com/en-gb/docs/developer-program/roku-pay/quickstart/in-channel-products.md)
2. Add CloudPay notification end point (supplied by StreamAMG) to the ***Roku Pay Web Services***.
3. Create CloudPay packages via the Admin console that match the IAP packages in terms of cost, type (renewable or non-renewable) and subscription length.
4. Add Providers and Product ID to the corresponding CloudPay packages via the Admin console.
5. Add ***Partner API Key*** access token to CloudPay admin console.
6. Forward User IAP receipt info to the CloudPay [verify](https://streamamg.stoplight.io/docs/cloudpay/reference/CloudPay-API-Specification.yaml/paths/~1iap~1verify/post) end point after a user purchase.



## Summary

All IAP integrations made via one of the four supported providers must push the raw receipt to the CloudPay [verify](https://streamamg.stoplight.io/docs/cloudpay/reference/CloudPay-API-Specification.yaml/paths/~1iap~1verify/post) endpoint.  This will validate the receipt with the provider to confirm the legitimacy of the purchase.

On successful validation, a user will be granted an entitlement that is used to access premium content either for a recurring or non-recurring basis.

Further updates to a user's subscription status will be handled by CloudPay once the integrator has added the relevant CloudPay endpoint and provided the access token to StreamAMG.  This will be in the form of re-validating receipts based on expiry dates/time and provider notification services.